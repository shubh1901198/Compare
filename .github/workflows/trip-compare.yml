name: Trip Comparison CI/CD

on:
  # Triggers the workflow on pushes to the main branch
  push:
    branches: [ main ]
  # Triggers the workflow every hour
  schedule:
    - cron: '0 * * * *'

jobs:
  compare-trips:
    runs-on: ubuntu-latest
    
    # CRITICAL: Permissions must be set to allow writing back to the repository
    permissions:
      contents: write # Grants the GITHUB_TOKEN write access for git push
      id-token: read # Keep read permission for checkout/general actions

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Create logs directory (if not exists)
      run: mkdir -p logs 

    - name: Run comparison script
      run: python Data_analysis.py
      
    # -----------------------------------------------
    # 1. COMMIT AND PUSH LOG FILE (USE WITH CAUTION)
    # -----------------------------------------------
    - name: Commit and Push Log
      run: |
        # Configure Git identity for the automated commit
        git config user.name github-actions
        git config user.email github-actions@github.com
        
        # Pull the latest changes before committing to avoid conflicts on schedule runs
        # The `--rebase` option avoids creating unnecessary merge commits.
        git pull --rebase
        
        # Stage the log file
        git add trip_comparison.log
        
        # Check if there are any changes to commit (e.g., if the log file changed)
        if git diff --cached --exit-code; then
          echo "No changes in trip_comparison.log. Skipping commit."
        else
          git commit -m "chore: Update comparison log from CI/CD run"
          # Push the new commit using the default GITHUB_TOKEN
          git push
          echo "Successfully committed and pushed new log."
        fi

    # The previous AWS S3 steps have been removed to use this new push strategy.
