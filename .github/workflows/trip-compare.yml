name: Trip Comparison CI/CD

on:
  # Triggers the workflow on pushes to the main branch
  push:
    branches: [ main ]
  # Triggers the workflow every hour
  schedule:
    - cron: '0 * * * *'

jobs:
  compare-trips:
    runs-on: ubuntu-latest
    # **UPDATED:** Grant write permission for the OIDC token
    permissions:
      id-token: write # Required for aws-actions/configure-aws-credentials
      contents: read # Required for actions/checkout

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Create logs directory (if not exists)
      run: mkdir -p logs 

    - name: Run comparison script
      run: python Data_analysis.py
      
    # -----------------------------------------------
    # 1. AWS CREDENTIALS CONFIGURATION (via OIDC)
    # -----------------------------------------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        # ⚠️ Replace this with your actual IAM Role ARN stored in GitHub Secrets
        role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
        # ⚠️ Replace 'us-east-1' with your desired AWS region
        aws-region: us-east-1 
        
    # -----------------------------------------------
    # 2. UPLOAD TO S3
    # -----------------------------------------------
    - name: Upload log file to S3
      run: |
        LOG_FILE="trip_comparison.log"
        # Create a unique path using the workflow run details
        S3_PATH="s3://your-s3-bucket-name/logs/${{ github.event_name }}/${{ github.run_id }}_${LOG_FILE}"
        
        echo "Uploading $LOG_FILE to S3 Path: $S3_PATH"
        
        # Use aws s3 cp command to upload the log file
        # ⚠️ Replace 'your-s3-bucket-name' with your actual bucket name
        aws s3 cp "$LOG_FILE" "$S3_PATH" --metadata "workflow-run-id=${{ github.run_id }}"
        
        echo "Verification:"
        aws s3 ls "s3://your-s3-bucket-name/logs/${{ github.event_name }}/"
        
